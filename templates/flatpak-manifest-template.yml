id: io.github.jmberesford.Retrom

runtime: org.gnome.Platform
runtime-version: "49"
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node22

command: Retrom
finish-args:
  # Permissions required for launching user-configured emulators/launchers on host via flatpak-spawn
  - --talk-name=org.freedesktop.Flatpak

  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc # Needed for performance reasons if the app fallbacks to X11
  - --socket=pulseaudio # Permissions required for emulator audio
  - --device=all # Need 'input' for gamepad support, but ubuntu flatpak version is old so this is a workaround

  # Permissions required for managing+launching user's game library and finding emulator executables on host
  - --filesystem=host-os

  # Permissions required for managing metadata (covers etc) from external providers, and for accessing optional remote dedicated Retrom server
  - --share=network

  - --env=FLATPAK=1

build-options:
  append-path: /usr/lib/sdk/node22/bin:/usr/lib/sdk/rust-stable/bin:/run/build/retrom/cargo/bin

modules:
  - name: retrom
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/JMBeresford/retrom
        tag: "{{ TAG_VALUE }}"
        commit: "{{ COMMIT_HASH }}"

      # Static web assets
      - type: archive
        url: https://github.com/JMBeresford/retrom/releases/download/{{ TAG_VALUE }}/desktop-frontend-dist.tar.gz
        sha256: "{{ WEB_DIST_SHA }}"
        strip-components: 0

      # Vendored cargo deps
      - type: archive
        url: https://github.com/JMBeresford/retrom/releases/download/{{ TAG_VALUE }}/cargo-deps.tar.gz
        sha256: "{{ CARGO_DEPS_SHA }}"
        strip-components: 0

    build-options:
      env:
        CARGO_HOME: /run/build/retrom/cargo
        XDG_CACHE_HOME: /run/build/retrom/flatpak-node/cache
        npm_config_cache: /run/build/retrom/flatpak-node/npm-cache
        npm_config_offline: "true"

    build-commands:
      - cargo fetch --offline
        --config source.crates-io.replace-with=\"vendored-sources\"
        --config source.vendored-sources.directory=\"vendor\"
        --manifest-path packages/client/Cargo.toml

      - cargo install --offline --path vendor/tauri-cli
        --config source.crates-io.replace-with=\"vendored-sources\"
        --config source.vendored-sources.directory=\"vendor\"

      - cd packages/client && cargo --offline
        tauri build --no-bundle --config ./tauri.build.conf.json --
        --features "flatpak"
        --offline
        --config source.crates-io.replace-with=\"vendored-sources\"
        --config source.vendored-sources.directory=\"../../vendor\"

      - install -Dm644 -t /app/share/metainfo/ io.github.jmberesford.Retrom.metainfo.xml
      - install -Dm644 -t /app/share/applications/ io.github.jmberesford.Retrom.desktop
      - install -Dm755 -t /app/bin/ target/release/Retrom

      - install -Dm644 packages/client/icons/32x32.png /app/share/icons/hicolor/32x32/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/128x128.png /app/share/icons/hicolor/128x128/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/128x128@2x.png /app/share/icons/hicolor/256x256/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/icon.png /app/share/icons/hicolor/256x256@2/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 LICENSE /app/share/licenses/io.github.jmberesford.Retrom/LICENSE
