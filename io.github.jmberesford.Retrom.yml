id: io.github.jmberesford.Retrom

runtime: org.gnome.Platform
runtime-version: "48"
sdk: org.gnome.Sdk//48
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node22

command: Retrom
finish-args:
  - --socket=wayland # Permission needed to show the window on wayland
  - --socket=fallback-x11 # Permission needed to fallback using X11 if wayland is not available
  - --share=ipc # Needed for performance reasons if the app fallbacks to X11
  - --socket=pulseaudio # We want to be able to play sounds
  - --device=dri # OpenGL
  - --device=input # For gamepad support
  - --filesystem=host
  - --env=FLATPAK=1
  - --share=network

build-options:
  append-path: /usr/lib/sdk/node22/bin:/usr/lib/sdk/rust-stable/bin:/run/build/retrom/cargo/bin

modules:
  - name: retrom
    buildsystem: simple
    sources:
      - type: git
        branch: feat/flatpak
        url: https://github.com/JMBeresford/retrom
        #tag: v0.7.43
        #commit: 7bad442f9b3872766c8ec49325da57f878806a8d
        commit: d04f4275fbc4e07db161a4fdaf447f8a647d2ef4

      - type: archive
        url: https://github.com/JMBeresford/retrom/releases/download/v0.7.43/web-dist_ubuntu-24.04.tar.gz
        sha256: 245f7e439582883445c94a250a56b09c6fe38c8ae5328a506978d6d072ac1f79
        strip-components: 0

      - type: archive
        url: https://github.com/JMBeresford/retrom/releases/download/v0.7.43/cargo-vendor_ubuntu-24.04.tar.gz
        sha256: 7266cfcd2753e80b51e140423418761bffe8f73a4dbc1cd704fee641b9568732
        strip-components: 0

    build-options:
      env:
        CARGO_HOME: /run/build/retrom/cargo
        XDG_CACHE_HOME: /run/build/retrom/flatpak-node/cache
        npm_config_cache: /run/build/retrom/flatpak-node/npm-cache
        npm_config_offline: "true"

    build-commands:
      - cargo fetch --offline 
          --config source.crates-io.replace-with=\"vendored-sources\" 
          --config source.vendored-sources.directory=\"vendor\" 
          --manifest-path packages/client/Cargo.toml

      - cargo install --offline --path vendor/tauri-cli
          --config source.crates-io.replace-with=\"vendored-sources\" 
          --config source.vendored-sources.directory=\"vendor\" 

      - cd packages/client && cargo --offline
          tauri build --no-bundle --config ./tauri.build.conf.json -- 
            --offline
            --config source.crates-io.replace-with=\"vendored-sources\" 
            --config source.vendored-sources.directory=\"../../vendor\" 

      - install -Dm644 -t /app/share/metainfo/ io.github.jmberesford.Retrom.metainfo.xml
      - install -Dm644 -t /app/share/applications/ io.github.jmberesford.Retrom.desktop
      - install -Dm755 -t /app/bin/ target/release/Retrom

      - install -Dm644 packages/client/icons/32x32.png /app/share/icons/hicolor/32x32/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/128x128.png /app/share/icons/hicolor/128x128/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/128x128@2x.png /app/share/icons/hicolor/256x256/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/icon.png /app/share/icons/hicolor/256x256@2/apps/io.github.jmberesford.Retrom.png

    post-install:
      - install -Dm644 LICENSE /app/share/licenses/io.github.jmberesford.Retrom/LICENSE

