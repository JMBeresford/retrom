id: io.github.jmberesford.Retrom

runtime: org.gnome.Platform
runtime-version: "47"
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node22

command: Retrom
finish-args:
  - --socket=wayland # Permission needed to show the window on wayland
  - --socket=fallback-x11 # Permission needed to fallback using X11 if wayland is not available
  - --share=ipc # Needed for performance reasons if the app fallbacks to X11
  - --socket=pulseaudio # We want to be able to play sounds
  - --device=dri # OpenGL
  - --env=FLATPAK=1
  - --share=network

build-options:
  append-path: /usr/lib/sdk/node22/bin:/usr/lib/sdk/rust-stable/bin

modules:
  - name: retrom
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/JMBeresford/retrom
        tag: v0.7.43
        commit: 7bad442f9b3872766c8ec49325da57f878806a8d

      - type: file
        url: https://github.com/JMBeresford/retrom/releases/download/untagged-920caafd72fcfd72d5f0/web-dist_ubuntu-24.04.tar.gz
        sha256: b8a2857bcf1b6875a29d534a14c57ac3879a339ab8b9ca160f7d321fe86698c7

      # Generated by flatpak-cargo-generator.py
      - cargo-sources.json

    build-options:
      env:
        CARGO_HOME: /run/build/retrom/cargo
        XDG_CACHE_HOME: /run/build/retrom/flatpak-node/cache
        npm_config_cache: /run/build/retrom/flatpak-node/npm-cache
        npm_config_offline: "true"

    build-commands:
      # Build application
      - tar -xvzf web-dist_ubuntu-24.04.tar.gz -C packages/client-web/dist
      - cargo --offline fetch --verbose
      - cd packages/client && cargo tauri build --config tauri.build.conf.json

      - install -Dm644 -t /app/share/metainfo/ io.github.jmberesford.Retrom.metainfo.xml
      - install -Dm644 -t /app/share/applications/ io.github.jmberesford.Retrom.desktop
      - install -Dm755 -t /app/bin/ target/release/Retrom

      - install -Dm644 packages/client/icons/32x32.png /app/share/icons/hicolor/32x32/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/128x128.png /app/share/icons/hicolor/128x128/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/128x128@2x.png /app/share/icons/hicolor/256x256/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/icon.png /app/share/icons/hicolor/256x256@2/apps/io.github.jmberesford.Retrom.png

    post-install:
      - install -Dm644 LICENSE /app/share/licenses/io.github.jmberesford.Retrom/LICENSE
